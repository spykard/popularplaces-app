# Populartimes 

The goal of this library is to provide an option to use *Google Maps* popular times data, until it is available via Google's API. 
For legal concerns please read [Issue #90](https://github.com/m-wrzr/populartimes/issues/90).  

Keep in mind that this API uses the Google Places Web Service, where each API call over a monthly budget is priced. The API call is SKU'd as "Find Current Place" with additional Data SKUs (Basic Data, Contact Data, Atmosphere Data).  As of February 2018, you can make 5000 calls with the alloted monthly budget.  For more information check https://developers.google.com/places/web-service/usage-and-billing and https://cloud.google.com/maps-platform/pricing/sheet/#places.  

As Google Maps is constantly updated this library can  be unstable.

Official Definition of the Feature (https://support.google.com/business/answer/6263531?hl=en):

* Popular times graph: This graph shows how busy your location typically is during different times of the day. Popular times are based on average popularity over the last few months. Popularity for **any given hour is shown relative to the typical peak popularity for the business for the week**. For example, in the image below, 8 PMâ€“9 PM on Saturday is one of the more popular times of the week for this business.  

<p align="center">
  <img src="https://raw.githubusercontent.com/spykard/populartimes/master/images/documentation.gif" alt="Documentation" width="280"/>
</p>

## Name

hot place to be  
trafficradar  
maxed.out  
popularplaces  
crowdedplaces  

## Todo

* Maybe implement map with ability for the user to select the coordinates directly on the /ui-maps page

## Links

Google's Usage and Billing:

https://developers.google.com/maps/documentation/places/web-service/usage-and-billing
https://cloud.google.com/maps-platform/pricing/sheet/#places

Google's Nearby Search Documentation:

https://developers.google.com/maps/documentation/places/web-service/search-nearby
https://developers.google.com/maps/documentation/places/web-service/search?hl=en#PlaceSearchRequests
https://developers.google.com/maps/documentation/places/web-service/supported_types

Alternative Implementations:

https://besttime.app/  
https://github.com/philshem/gmaps_popular_times_scraper/
https://populartimes.herokuapp.com/

https://github.com/bluemelodybox/flask-popularplaces

Data on dashboard is acquired from Google popular times, updated every 15 minutes. Google uses aggregated and anonymised data from users who have opted in to Google location history to make a reasonable estimate of how many users are in a given location at any given time of the day.

High crowd - places that have more than 50% crowd

Gaining crowd - places that have more than 10% gain in crowd for the past 15 minutes

Usual crowd - shows how active a location typically is currently, based on average popularity over the past few months.

Current crowd - shows how active a location is right now as a percentage of its estimated maximum capacity.

Crowd ratio - shows how active a location is right now compared to its usual level of activity

Crowd changes - shows the percentage change in crowd in the last 15 minutes



Interface Documentation:

https://demos.creative-tim.com/black-dashboard-flask/docs/1.0/getting-started/getting-started-flask.html

## How to get started
+ Get a Google Maps API key https://developers.google.com/places/web-service/get-api-key 
+ `clone` the repository, `cd` into the populartimes directory and run `pip install .`
+ Alternatively install directly from github using `pip install --upgrade git+https://github.com/m-wrzr/populartimes`
+ `import populartimes` and run with `populartimes.get(...)` or `populartimes.get_id(...)`
 + **Note**: The library is not available via PyPI, so you have to clone/download the repository and install it locally.

## populartimes.get_id(...)
Retrieves information for a given place id and adds populartimes, wait, time_spent and other data not accessible via Google Places.

+ **populartimes.get_id**(api_key, place_id)
    + **api_key** str; api key from google places web service; e.g. "your-api-key"
    + **place_id** str; unique google maps id; retrievable via populartimes.get() or https://developers.google.com/maps/documentation/javascript/examples/places-placeid-finder

+ **Example call**
    + populartimes.get_id("your-api-key", "ChIJSYuuSx9awokRyrrOFTGg0GY")

+ **Response**
    + The response is formatted is equal to the .json described below.
    + The information present for places is highly varying. Therefore *popularity*, *current_popularity*, *rating*, *rating_n*, *time_wait*, *time_spent* and *phone* are optional return parameters and only present if available.
    + *time_wait* and *time_spent* are in minutes
    + **Note**: The *time_wait* and *time_spent* parameters were only added recently to Google Maps and are only present as a language specific string. The extracted values may therefore be incorrect and you might have to parse the raw string yourself, depending on your language settings.

```json
{
  "id": "ChIJSYuuSx9awokRyrrOFTGg0GY",
  "name": "Gran Morsi",
  "address": "22 Warren St, New York, NY 10007, USA",
  "types": [
    "restaurant",
    "food",
    "point_of_interest",
    "establishment"
  ],
  "coordinates": {
    "lat": 40.71431500000001,
    "lng": -74.007766
  },
  "rating": 4.4,
  "rating_n": 129,
  "international_phone_number": "+1 212-577-2725",
    "time_spent": [
    90,
    180
  ],
  "current_popularity": 33,
  "populartimes": [
    {
      "name": "Monday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 19, 20, 17, 0, 0, 20, 28, 26, 18, 10, 6, 0
      ]
    },
    {
      "name": "Tuesday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 27, 19, 10, 0, 0, 34, 42, 42, 35, 26, 15, 0
      ]
    },
    {
      "name": "Wednesday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 28, 34, 23, 13, 0, 0, 36, 46, 47, 39, 26, 13, 0
      ]
    },
    {
      "name": "Thursday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 28, 42, 42, 28, 0, 0, 59, 61, 46, 39, 32, 20, 0
      ]
    },
    {
      "name": "Friday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 30, 44, 40, 28, 0, 0, 70, 96, 100, 80, 48, 22, 0
      ]
    },
    {
      "name": "Saturday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 34, 42, 48, 47, 36, 21, 0
      ]
    },
    {
      "name": "Sunday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 27, 34, 34, 28, 21, 10, 0
      ]
    }
  ],
  "time_wait": [
    {
      "name": "Monday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 0, 0, 0, 0, 15, 15, 15, 0, 15, 15, 0
      ]
    },
    {
      "name": "Tuesday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 0, 0, 0, 0, 0, 15, 15, 15, 15, 15, 0
      ]
    },
    {
      "name": "Wednesday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 15, 15, 15, 15, 15, 0
      ]
    },
    {
      "name": "Thursday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 0, 0, 0, 0, 0, 15, 15, 15, 15, 15, 0
      ]
    },
    {
      "name": "Friday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 15, 15, 15, 15, 0
      ]
    },
    {
      "name": "Saturday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 15, 15, 15, 15, 0
      ]
    },
    {
      "name": "Sunday",
      "data": [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 15, 15, 0, 0, 0
      ]
    }
  ]
}
```


## populartimes.get(...)

Retrieves information for a given area according to place types and bounds. Adds populartimes, wait, time_spent and other data not accessible via Google Places.

+ **populartimes.get**(api_key, types, bound_lower, bound_upper, n_threads (opt), radius (opt), all_places (opt))
    + **api_key** str; api key from google places web service; e.g. "your-api-key"
    + **types** [str]; placetypes; see https://developers.google.com/places/supported_types; e.g. ["bar"]
    + **p1** (float, float); lat/lng of point delimiting the search area; e.g. (48.132986, 11.566126)
    + **p2** (float, float); lat/lng of point delimiting the search area; e.g. (48.142199, 11.580047)
    + **n_threads (opt)** int; number of threads used; e.g. 20
    + **radius (opt)** int; meters; up to 50,000 for radar search; e.g. 180; this has can be adapted for very dense areas
    + **all_places (opt)** bool; include/exclude places without populartimes

+ **Example call**
    + populartimes.get("your-api-key", ["bar"], (48.132986, 11.566126), (48.142199, 11.580047))


+ **Response**
    + The values are derived from a combination of google searches, google maps app location data, and local traffic data. This data is  then used on a per location basis and gives a weekly (by hour and by day) reading for how busy that particular location is on a scale of 1-100. (1 being the least busy, 100 being the busiest a particular location gets, 0 indicating a time that a location is closed).
    + The data is represented as a list of dictionaries, with responses according to the example above
    + The *populartimes* data for each day is an array of length 24, with populartimes data starting from hour 0 to 23, the *wait* data is formatted similarly,
    + *popularity*, *current_popularity*, *rating*, *rating_n*, *time_wait*, *time_spent* and *phone* are optional return parameters and only present if available.
  
 ## Example how the data can be used for visualization  
 ![Bars-Gif](/content/bars_visualization.gif "Bars Munich,Berlin,Barcelona, London")
